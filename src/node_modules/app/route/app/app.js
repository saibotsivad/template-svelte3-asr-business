import App from './App.svelte'
import catchify from 'app/module/catchify.js'
import fetchCurrentUser from 'app/api/fetch-current-user.js'
import logOutUser from 'app/api/log-out-user.js'

export default ({ asr }) => {
	asr.addState({
		name: 'app',
		route: '/app',
		defaultChild: 'dashboard',
		template: App,
		resolve: async (data, parameters) => {
			return {
				currentUser: await fetchCurrentUser()
			}
		},
		activate: ({ domApi }) => {
			domApi.$on('logout', async () => {
				const [ error ] = await catchify(logOutUser())
				if (error) {
					console.error('Error while logging user out. TODO handle this error.', error)
				} else {
					asr.go('login')
				}
			})
		}
	})
}
