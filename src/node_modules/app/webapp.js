import makeSvelteStateRenderer from 'svelte-state-renderer'
import StateRouter from 'abstract-state-router'

import globbedRoutes from './globbed-routes.js'

const defaultParameters = {
	props: {
		annoy() {
			alert('Modal dialogs are annoying')
		}
	}
}

const renderer = makeSvelteStateRenderer(defaultParameters)
const asr = StateRouter(renderer, document.body)

const mostRecentStateChangeStart = {}

asr.on('stateChangeStart', (state, params, states) => {
	mostRecentStateChangeStart.name = state && state.name
	mostRecentStateChangeStart.params = params
})

asr.on('stateChangeError', error => {
	// Catch API requests that are authentication errors
	// and redirect to the login page.
	if (error && error.status === 401) {
		asr.go('login', {
			redirect: JSON.stringify(mostRecentStateChangeStart)
		})
	}
})

globbedRoutes.forEach(route => route({ asr }))

// If there is no route specified in the URL, send them
// to the login page first. You might have a different
// first-load view, such as some unsecured dashboard, that
// you would like to use instead.
asr.evaluateCurrentRoute('login')

export default asr
